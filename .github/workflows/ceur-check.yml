name: CEUR PRECHECK

on:
  issues:
    types: [opened, labeled]

jobs:
  ceur-precheck:
    if: contains(github.event.issue.labels.*.name, 'precheck')
    runs-on: ubuntu-latest

    permissions:
      issues: write

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-pdfminer poppler-utils perl

      - name: Extract PDF from issue
        run: |
          BODY="${{ github.event.issue.body }}"
          URL=$(echo "$BODY" | grep -o 'https://[^ ]*\.pdf')

          if [ -z "$URL" ]; then
            echo "No PDF attachment found."
            exit 1
          fi

          curl -L "$URL" -o submission.pdf

      - name: Make CEUR script executable
        run: chmod +x check-pdf-errors

      - name: Run CEUR validation
        id: run_check
        run: |
          set +e
          OUTPUT=$(./check-pdf-errors 2>&1)
          echo "$OUTPUT" > result.txt

          if echo "$OUTPUT" | grep -q "^ERROR:"; then
            echo "status=fail" >> $GITHUB_OUTPUT
          else
            echo "status=pass" >> $GITHUB_OUTPUT
          fi

      - name: Post results to Issue
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const output = fs.readFileSync('result.txt', 'utf8');
            const passed = "${{ steps.run_check.outputs.status }}" === "pass";

            let body = "## CEUR PRECHECK REPORT\n\n";
            body += "```\n";
            body += output;
            body += "\n```\n\n";

            if (passed) {
              body += "**CEUR PRECHECK REPORT**\n\n";
            } else {
              body += "‚ùå **CEUR PRECHECK FAILED**\n\n";
            }

            body += "Each submission requires a new Issue. If you revise your paper, open a new Issue and upload the updated PDF.";

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

            if (!passed) {
              core.setFailed("CEUR check failed");
            }

      - name: Close issue
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.update({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: "closed"
            });
